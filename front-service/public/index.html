<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Gestion Étudiants - Architecture Event Driven</title>
    <style>
        /* --- STYLE DE BASE --- */
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; background-color: #f4f7f6; }
        
        /* Boutons */
        button { padding: 8px 15px; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; color: white; transition: 0.2s; }
        .btn-create { background: #28a745; margin-bottom: 15px; } /* Vert */
        .btn-refresh { background: #17a2b8; float: right; } /* Bleu Cyan */
        .btn-edit { background: #ffc107; color: #333; margin-right: 5px; } /* Jaune */
        .btn-del { background: #dc3545; } /* Rouge */
        .btn-save { background: #007bff; } /* Bleu Principal */
        .btn-cancel { background: #6c757d; margin-right: 10px; } /* Gris */

        /* Tableau */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        th { background: #007bff; color: white; padding: 12px; text-align: left; }
        td { border-bottom: 1px solid #ddd; padding: 10px; }
        tr:hover { background-color: #f1f1f1; }

        #log { font-weight: bold; text-align: center; margin-bottom: 10px; height: 20px; }

        /* --- STYLE DE LA POPUP (MODAL) --- */
        .modal {
            display: none; /* Caché par défaut */
            position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); /* Fond sombre transparent */
            backdrop-filter: blur(4px); /* Petit effet de flou */
        }
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 25px;
            border-radius: 8px;
            width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown { from {top: -50px; opacity: 0;} to {top: 0; opacity: 1;} }

        /* Formulaire interne */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-group input { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .modal-actions { text-align: right; margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Gestion des étudiants</h1>
    <div id="log">En attente de connexion...</div>

    <div>
        <button class="btn-create" onclick="openCreateModal()">Ajouter un Étudiant</button>
        <button class="btn-refresh" onclick="sendAction('GET_ALL')">Actualiser</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Nom</th>
                <th>Prénom</th>
                <th>Email</th>
                <th>Formation</th> <th>Actions</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <div id="studentModal" class="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Nouvel Étudiant</h2>
            
            <input type="hidden" id="studentId"> 
            
            <div class="form-group">
                <label>Nom</label>
                <input type="text" id="nom" placeholder="Ex: Dupont">
            </div>
            <div class="form-group">
                <label>Prénom</label>
                <input type="text" id="prenom" placeholder="Ex: Jean">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="mail" placeholder="jean.dupont@email.com">
            </div>
            <div class="form-group">
                <label>Formation</label>
                <input type="text" id="formation" placeholder="Ex: FISE ICY">
            </div>

            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal()">Annuler</button>
                <button class="btn-save" onclick="submitForm()">Enregistrer</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const log = document.getElementById('log');
        const tbody = document.getElementById('tableBody');
        const modal = document.getElementById('studentModal');

        // --- Gestion de la connexion ---

        socket.on('system_status', (status) => {
            if (status.ready) {
                log.style.color = 'green';
                log.innerText = "Système Connecté";
                
                // On charge une première fois les données automatiquement 
                if(document.getElementById('tableBody').innerHTML === "") {
                    sendAction('GET_ALL');
                }
            } else {
                log.style.color = 'orange';
                log.innerText = "Connexion au système Kafka... (Veuillez patienter)";
            }
        });

        // --- GESTION DE LA POPUP ---
        
        function openCreateModal() {
            // On vide tout pour une création
            document.getElementById('studentId').value = "";
            document.getElementById('nom').value = "";
            document.getElementById('prenom').value = "";
            document.getElementById('mail').value = "";
            document.getElementById('formation').value = "";
            
            document.getElementById('modalTitle').innerText = "Nouvel Étudiant";
            modal.style.display = "block";
        }

        function openEditModal(s) {
            // On remplit avec les données de l'étudiant cliqué
            document.getElementById('studentId').value = s.id;
            document.getElementById('nom').value = s.nom;
            document.getElementById('prenom').value = s.prenom;
            document.getElementById('mail').value = s.mail;
            document.getElementById('formation').value = s.formation;

            document.getElementById('modalTitle').innerText = "Modifier l'étudiant #" + s.id;
            modal.style.display = "block";
        }

        function closeModal() {
            modal.style.display = "none";
        }

        // Fermer la popup si on clique à côté (sur le fond gris)
        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        // --- LOGIQUE D'ENVOI (CREATE ou UPDATE) ---

        function submitForm() {
            // On regarde si on a un ID caché
            const id = document.getElementById('studentId').value;
            
            // Si ID existe -> UPDATE, sinon -> CREATE
            const actionType = id ? 'UPDATE' : 'CREATE';

            const studentData = {
                nom: document.getElementById('nom').value,
                prenom: document.getElementById('prenom').value,
                mail: document.getElementById('mail').value,
                formation: document.getElementById('formation').value
            };

            // Validation basique
            if(!studentData.nom || !studentData.mail) {
                alert("Nom et Email obligatoires !");
                return;
            }

            // Envoi au serveur Node
            socket.emit('front_action', { 
                action: actionType, 
                student: studentData, 
                targetId: id // Important pour l'update
            });

            closeModal(); // On ferme la popup immédiatement
        }

        function sendAction(actionType, id = null) {
            if (actionType === 'DELETE') {
                if(!confirm("Supprimer cet étudiant ?")) return;
            }
            socket.emit('front_action', { action: actionType, targetId: id });
        }

        // --- RECEPTION KAFKA ---

        socket.on('kafka_response', (res) => {
            console.log("Reçu :", res);
            
            if (!res.success && res.message) {
                log.style.color = 'red';
                log.innerText = "Erreur : " + res.message;
                return;
            }

            log.style.color = 'green';
            log.innerText = `Succès : ${res.action}`;

            switch(res.action) {
                case 'GET_ALL':
                    renderTable(res.data);
                    break;
                case 'CREATE':
                case 'DELETE':
                case 'UPDATE': // L'Update déclenche aussi le rechargement
                    sendAction('GET_ALL'); 
                    break;
            }
        });

        function renderTable(list) {
            tbody.innerHTML = "";
            if(list && Array.isArray(list)) {
                list.sort((a, b) => a.id - b.id);
                list.forEach(s => {
                    // Petite astuce pour passer l'objet JSON dans le onclick sans casser les guillemets
                    const safeData = JSON.stringify(s).replace(/"/g, "&quot;");

                    tbody.innerHTML += `
                        <tr>
                            <td><b>${s.id}</b></td>
                            <td>${s.nom}</td>
                            <td>${s.prenom}</td>
                            <td>${s.mail}</td>
                            <td>${s.formation || '-'}</td>
                            <td>
                                <button class="btn-edit" onclick="openEditModal(${safeData})">Modifier</button>
                                <button class="btn-del" onclick="sendAction('DELETE', ${s.id})">Supprimer</button>
                            </td>
                        </tr>`;
                });
            } else {
                tbody.innerHTML = "<tr><td colspan='6' style='text-align:center'>Aucun étudiant</td></tr>";
            }
        }
    </script>
</body>
</html>